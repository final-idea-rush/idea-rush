<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Idea Detail</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Custom CSS */
        #content {
            font-size: 18px;
            padding: 20px;
        }
        /* Adding border to card */
        .bordered-card {
            border: 2px solid #ccc;
            border-radius: 10px;
        }

        /* Centering the title */
        .card-header.text-center {
            text-align: center;
        }

        /* Styling the footer */
        .card-footer {
            background-color: #f9f9f9;
            border-top: 1px solid #ccc;
        }

    </style>
</head>
<body>
<!--&lt;!&ndash; 네비게이션 바 &ndash;&gt;-->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <img src="/image/logo.svg" style="height: 35px; width: 35px"></img>
    <a class="navbar-brand" href="/" style="margin-left: 5px">Idea Rush</a>
</nav>

<div class="container mt-4">
    <div class="row">
        <!-- Left Side (Image) -->
        <div class="col-md-6">
            <div class="card bordered-card" style="height: 550px;">
                <div class="card-body d-flex align-items-center justify-content-center" style="height: 100%;">
                    <img id="image" class="img-fluid" style="object-fit: contain; width: 100%; height: 100%;">
                </div>
            </div>
            <!-- Card for details -->
            <div class="card mt-4 bordered-card" style="height: 190px;">
                <div class="card-body">
                    <h3 id="title" class="card-title"></h3>
                    <p id="writer" class="card-text"></p>
                    <p id="status" class="card-text"></p>
                    <p id="minimumStartingPrice" class="card-text"></p>
                    <p id="BidWinPrice" class="card-text"></p>
                </div>
            </div>
        </div>

        <!-- Right Side (SSE and Content) -->
        <div class="col-md-6">
            <!-- SSE Card -->
            <div class="card bordered-card" style="height: 550px;">
                <div class="card-header text-center">
                    <h3 class="card-title">실시간 입찰 현황</h3>
                </div>
                <div class="card-body d-flex flex-column" id="sse-data" style="height: calc(100% - 100px); overflow-y: auto;">
                    <!-- SSE data will be appended here -->
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="number" class="form-control" id="bid-price" placeholder="입찰가격을 입력하세요">
                        <div class="input-group-append">
                            <button class="btn btn-primary" id="bid-button">입찰</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Content Card -->
            <div class="card mt-4 bordered-card" style="height: 190px;">
                <div class="card-body" id="content" style="max-height: 100%; overflow-y: auto;">
                    <!-- Content will go here -->
                </div>
            </div>

            <div class="text-right mt-2">
                <button class="btn btn-secondary btn-sm" id="edit-button">수정</button>
            </div>
        </div>
    </div>
</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    const url = new URL(window.location.href);
    const urlParams = url.searchParams;

    let ideaId = urlParams.get('id');
    let sendUrl = "/api/ideas/" + ideaId;

    function isValidImageUrl(url, callback) {
        var img = new Image();
        img.onload = function() {
            callback(true);
        };
        img.onerror = function() {
            callback(false);
        };
        img.src = url;
    }

    $(document).ready(function() {
        $.ajax({
            url: sendUrl,
            method: "GET",
            success: function(data) {
                console.log("Received data:", data);
                $("#title").text(data.title);
                $("#writer").html("<strong>작성자:</strong> " + data.writer);
                $("#status").html("<strong>경매 상태:</strong> " + data.status);

                if (data.status === "END") {
                    $("#BidWinPrice").html("<strong>낙찰가:</strong> " + data.BidWinPrice);
                    $("#BidWinPrice").show();
                    $("#minimumStartingPrice").hide();
                } else {
                    $("#BidWinPrice").hide();
                    $("#minimumStartingPrice").html("<strong>최소 입찰 금액:</strong> " + data.minimumStartingPrice);
                    $("#minimumStartingPrice").show();
                }

                $("#content").text(data.content);

                isValidImageUrl(data.imageUrl, function(isValid) {
                    if (isValid) {
                        $("#image").attr("src", data.imageUrl);
                    } else {
                        $("#image").attr("src", "/image/logo.svg");
                    }
                });
                //writerId를 response에서 받아와야 할 듯
                // var loggedInUserId = localStorage.getItem('userId');
                // if (data.writerId === loggedInUserId) {
                //     $("#edit-button").show();  // '수정' 버튼 보여주기
                // } else {
                //     $("#edit-button").hide();  // '수정' 버튼 숨기기
                // }
            },
            error: function(err) {
                console.log("An error occurred:", err);
            }
        });

        // SSE
        var eventSource = new EventSource("http://54.180.135.121:8080/api/sse/connect/idea/" + ideaId);
        eventSource.addEventListener('BID_PRICE_UPDATE', function(e) {
            console.log("Bid price update event received:", e.data);

            var newElement = document.createElement('p');
            newElement.textContent = e.data + '원에 입찰 되었습니다.';

            var sseDataDiv = document.getElementById('sse-data');
            sseDataDiv.appendChild(newElement);
        }, false);

        // 입찰 버튼을 눌렀을 때의 이벤트 처리
        $("#bid-button").click(function() {
            var bidPrice = $("#bid-price").val(); // 입력된 입찰가격 가져오기

            // 빈 값인지 검증
            if (!bidPrice) {
                alert("입찰 가격을 입력해주세요.");
                return;
            }

            // BidRequest 객체 생성
            var bidRequest = {
                "bidPrice": parseInt(bidPrice)
            };

            // 서버에 POST 요청 보내기
            $.ajax({
                url: "http://3.36.98.58:8080/api/ideas/" + ideaId + "/bid",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(bidRequest),
                // headers: {
                //       // 헤더에 토큰 추가
                // },
                success: function(response) {
                    console.log("Bid successfully created:", response);
                    alert("입찰이 성공적으로 완료되었습니다.");
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log("An error occurred while creating the bid:", jqXHR, textStatus, errorThrown);

                    // HTTP 상태 코드가 401인 경우 로그인 필요 알림 띄우기
                    if(jqXHR.status === 401) {
                        alert("로그인이 필요합니다.");
                    } else {
                        alert("유효하지 않은 입찰금액입니다.");
                    }
                }
            });
        });


    });
</script>
